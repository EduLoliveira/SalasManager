{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalesManager - Sistema de Vendas</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Poppins:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{% static 'sales/css/listSale.css' %}">
    <link rel="stylesheet" href="{% static 'sales/css/listFunc.css' %}">
 
</head>

<body>

    <!-- NOTIFICA√á√ÉO DE SUCESSO (ESTRUTURA ORIGINAL) -->
    <div id="successNotification" class="notification">
        <div class="notification-header">
            <div class="notification-title">
                <i class="bi bi-check-circle-fill"></i> Venda registrada com sucesso!
            </div>
            <button class="notification-close" onclick="hideNotification()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="notification-content">
            <div class="notification-item">
                <span class="notification-label">Cliente:</span>
                <span class="notification-value" id="notif-cliente"></span>
            </div>
            <div class="notification-item">
                <span class="notification-label">Quantidade:</span>
                <span class="notification-value" id="notif-quantidade"></span>
            </div>
            <div class="notification-item">
                <span class="notification-label">Valor:</span>
                <span class="notification-value" id="notif-valor"></span>
            </div>
            <div class="notification-item">
                <span class="notification-label">Data:</span>
                <span class="notification-value" id="notif-data"></span>
            </div>
        </div>
        <div class="notification-progress">
            <div class="notification-progress-bar"></div>
        </div>
    </div>

    <div class="main-container">
        <div class="tabs">
            <a href="?status=ativas{% if busca %}&busca={{ busca }}{% if data_inicio %}&data_inicio={{ data_inicio }}{% endif %}{% if data_fim %}&data_fim={{ data_fim }}{% endif %}{% if ordenar_por %}&ordenar_por={{ ordenar_por }}{% endif %}{% endif %}"
                class="tab {% if status == 'ativas' or not status %}active{% endif %}">Pendentes</a>
            <a href="?status=baixadas{% if busca %}&busca={{ busca }}{% if data_inicio %}&data_inicio={{ data_inicio }}{% endif %}{% if data_fim %}&data_fim={{ data_fim }}{% endif %}{% if ordenar_por %}&ordenar_por={{ ordenar_por }}{% endif %}{% endif %}"
                class="tab {% if status == 'baixadas' %}active{% endif %}">Baixa</a>
        </div>

        <!-- FORMUL√ÅRIO CORRIGIDO - Removidos os campos hidden problem√°ticos -->
        <form id="filtersForm" method="get" action="{% url 'sales:lista_vendas' %}">
            <div class="search-section">
                <div class="flex-dashboard">
                    <h2>Buscar cliente</h2>
                    <a href="{% url 'sales:dashboard' %}" class="back-link">
                        <i class="bi bi-arrow-left"></i> Voltar para o Dashboard
                    </a>
                </div>
                <div class="search-bar">
                    <i class="bi bi-search"></i>
                    <input type="text" name="busca" placeholder="Digite o nome do cliente e pressione Enter..."
                        value="{{ busca }}">
                </div>
            </div>

            <div class="filters-wrapper">
                <button type="button" id="toggleFiltersBtn" class="toggle-filters-button">
                    <i class="bi bi-sliders"></i> Visualizar Filtros
                </button>

                <div id="filtersContent" class="filters-container hidden">
                    <!-- CAMPOS HIDDEN REMOVIDOS - eles estavam causando o problema -->
                    
                    <div class="filter-group">
                        <label for="status">Status</label>
                        <select id="status" name="status" class="filter-select">
                            <option value="ativas" {% if status == 'ativas' or not status %}selected{% endif %}>Pendentes</option>
                            <option value="baixadas" {% if status == 'baixadas' %}selected{% endif %}>Baixadas</option>
                            <option value="todas" {% if status == 'todas' %}selected{% endif %}>Todas</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="data_inicio">Data in√≠cio</label>
                        <input type="date" id="data_inicio" name="data_inicio" value="{{ data_inicio }}">
                    </div>
                    <div class="filter-group">
                        <label for="data_fim">Data fim</label>
                        <input type="date" id="data_fim" name="data_fim" value="{{ data_fim }}">
                    </div>
                    <div class="filter-group">
                        <label for="ordenar_por">Ordenar por</label>
                        <select id="ordenar_por" name="ordenar_por" class="filter-select">
                            <option value="-data_venda" {% if ordenar_por == "-data_venda" %}selected{% endif %}>Mais recentes</option>
                            <option value="data_venda" {% if ordenar_por == "data_venda" %}selected{% endif %}>Mais antigos</option>
                            <option value="cliente" {% if ordenar_por == "cliente" %}selected{% endif %}>Cliente A-Z</option>
                            <option value="-cliente" {% if ordenar_por == "-cliente" %}selected{% endif %}>Cliente Z-A</option>
                            <option value="-valor" {% if ordenar_por == "-valor" %}selected{% endif %}>Maior valor</option>
                            <option value="valor" {% if ordenar_por == "valor" %}selected{% endif %}>Menor valor</option>
                        </select>
                    </div>
                    <div class="filter-button-container">
                        <button type="submit" class="filter-button">
                            <i class="bi bi-funnel"></i> Aplicar Filtros
                        </button>
                        <a href="{% url 'sales:lista_vendas' %}" class="filter-button" style="background: var(--danger-color); margin-left: 10px;">
                            <i class="bi bi-x-circle"></i> Limpar Filtros
                        </a>
                    </div>
                </div>
            </div>
        </form>
        
        {% if vendas %}
        <!-- Container para a lista de vendas com altura limitada inicialmente -->
        <div id="vendasContainer" class="vendas-container">
            <table class="vendas-table">
                <thead>
                    <tr>
                        <th>CLIENTE</th>
                        <th>QTD</th>
                        <th>VALOR</th>
                        <th>A√á√ÉO</th>
                    </tr>
                </thead>
                <tbody>
                    {% for venda in vendas %}
                    <tr>
                        <td>
                            <div class="cliente-cell">
                                <div class="cliente-nome">{{ venda.cliente }}</div>
                                <div class="cliente-data">{{ venda.data_venda|date:"d/m/Y" }}</div>
                            </div>
                        </td>
                        <td style="font-weight: bold; color: black;">{{ venda.quantidade }}</td>
                        <td class="valor-cell">R$ {{ venda.valor|floatformat:2 }}</td>
                        <td>
                            <a href="{% url 'sales:baixar_venda' venda.id %}"
                                class="action-btn {% if venda.baixada %}btn-reverter{% else %}btn-baixar{% endif %}"
                                title="{% if venda.baixada %}Reverter baixa{% else %}Dar baixa na venda{% endif %}">

                                {% if venda.baixada %}
                                <i class="bi bi-arrow-counterclockwise"></i> Reverter
                                {% else %}
                                <i class="bi bi-check-circle"></i> Baixar
                                {% endif %}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <br>    
        <!-- Bot√£o para expandir/contrair a lista -->
        <button id="toggleListBtn" class="toggle-list-btn">
            <i class="bi bi-chevron-down"></i> Exibir todos os clientes
        </button>
        {% else %}
        <div class="lista-vazia">
            <i class="bi bi-receipt"></i>
            <h3>Nenhuma venda encontrada</h3>
            <p>{% if status == 'baixadas' %}Nenhuma venda baixada corresponde aos filtros selecionados.{% else %}Nenhuma
                venda pendente corresponde √† sua busca.{% endif %}</p>
        </div>
        {% endif %}

    </div>

    <div class="totals-card">
        <h3>Resumo</h3>
        <div class="total-grid">
            <div class="total-item">
                <span class="total-label">Total de vendas</span>
                <span class="total-value">{{ total_vendas }}</span>
            </div>
            <div class="total-item">
                <span class="total-label">Valor total</span>
                <span class="total-value">R$ {{ total_valor|floatformat:2 }}</span>
            </div>
        </div>
    </div>
    <br>
    <br>
    <br>

    <!-- Footer ID√äNTICO ao solicitado -->
    <footer class="footer">
        <nav class="footer-nav">
            <a href="{% url 'sales:dashboard' %}" class="footer-button">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="{% url 'sales:lista_vendas' %}" class="footer-button active">
                <i class="fas fa-shopping-cart"></i>
                <span>Vendas</span>
            </a>
            <a href="{% url 'sales:cadastrar_venda' %}" class="footer-button">
                <i class="fas fa-plus-circle"></i>
                <span>Cadastrar</span>
            </a>
        </nav>
    </footer>


    <!-- CSS PARA A NOTIFICA√á√ÉO -->
    <style>
    .notification {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-left: 4px solid #10b981;
        z-index: 1000;
        max-width: 500px;
        animation: slideInRight 0.3s ease;
    }
    
    .notification.show {
        display: block;
    }
    
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px 0;
        margin-bottom: 12px;
    }
    
    .notification-title {
        font-weight: 600;
        color: #065f46;
        font-size: 16px;
    }
    
    .notification-title i {
        color: #10b981;
        margin-right: 8px;
    }
    
    .notification-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #6b7280;
        padding: 4px;
    }
    
    .notification-close:hover {
        color: #374151;
    }
    
    .notification-content {
        padding: 0 20px 16px;
    }
    
    .notification-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 4px 0;
    }
    
    .notification-label {
        font-weight: 500;
        color: #4b5563;
    }
    
    .notification-value {
        font-weight: 600;
        color: #111827;
    }
    
    .notification-progress {
        height: 4px;
        background: #e5e7eb;
        border-radius: 0 0 12px 12px;
        overflow: hidden;
    }
    
    .notification-progress-bar {
        height: 100%;
        background: #10b981;
        width: 100%;
        transform-origin: left;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes notificationProgress {
        from {
            transform: scaleX(1);
        }
        to {
            transform: scaleX(0);
        }
    }
    </style>

    <!-- JAVASCRIPT INCORPORADO NO HTML -->
    <script>
    // Fun√ß√£o para obter o cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Fun√ß√£o para mostrar a notifica√ß√£o
    function showNotification(vendaData) {
        const notification = document.getElementById('successNotification');
        
        console.log('üì¢ Exibindo notifica√ß√£o com dados:', vendaData);
        
        if (!notification) {
            console.error('‚ùå Elemento da notifica√ß√£o n√£o encontrado');
            return;
        }
        
        // Preencher os dados da notifica√ß√£o
        const clienteElement = document.getElementById('notif-cliente');
        const quantidadeElement = document.getElementById('notif-quantidade');
        const valorElement = document.getElementById('notif-valor');
        const dataElement = document.getElementById('notif-data');
        
        if (clienteElement) clienteElement.textContent = vendaData.cliente || 'N√£o informado';
        if (quantidadeElement) quantidadeElement.textContent = vendaData.quantidade || 'N√£o informado';
        if (valorElement) valorElement.textContent = vendaData.valor ? 'R$ ' + parseFloat(vendaData.valor).toFixed(2) : 'N√£o informado';
        if (dataElement) dataElement.textContent = vendaData.data_venda || vendaData.data || 'N√£o informado';
        
        // Mostrar a notifica√ß√£o com anima√ß√£o
        notification.classList.add('show');
        
        // Reiniciar anima√ß√£o da barra de progresso
        const progressBar = document.querySelector('.notification-progress-bar');
        if (progressBar) {
            progressBar.style.animation = 'none';
            setTimeout(() => {
                progressBar.style.animation = 'notificationProgress 10s linear forwards';
            }, 10);
        }
        
        // Auto-esconder ap√≥s 10 segundos
        window.notificationTimeout = setTimeout(hideNotification, 10000);
    }

    // Fun√ß√£o para esconder a notifica√ß√£o
    function hideNotification() {
        const notification = document.getElementById('successNotification');
        if (notification) {
            notification.classList.remove('show');
        }
        if (window.notificationTimeout) {
            clearTimeout(window.notificationTimeout);
        }
        
        // Limpar a sess√£o
        fetch('/clear_venda_session/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        }).catch(error => console.error('Error ao limpar sess√£o:', error));
    }

    // Aguarda o documento carregar completamente
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üîç Iniciando verifica√ß√£o de sess√£o...');

        // C√≥digo para o bot√£o de filtros
        const toggleButton = document.getElementById('toggleFiltersBtn');
        const filtersContent = document.getElementById('filtersContent');

        if (toggleButton && filtersContent) {
            toggleButton.addEventListener('click', function () {
                filtersContent.classList.toggle('hidden');
                const isHidden = filtersContent.classList.contains('hidden');
                if (isHidden) {
                    toggleButton.innerHTML = '<i class="bi bi-sliders"></i> Visualizar Filtros';
                } else {
                    toggleButton.innerHTML = '<i class="bi bi-x-lg"></i> Ocultar Filtros';
                }
            });
        }

        // VERIFICA√á√ÉO DIRETA DA SESS√ÉO - M√âTODO ALTERNATIVO
        console.log('üîç Verificando sess√£o de venda...');
        
        // M√©todo 1: Tentar buscar da API
        fetch('/check_venda_session/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na requisi√ß√£o: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('üì¶ Dados recebidos da API:', data);
                if (data.has_venda_data && data.venda_data) {
                    console.log('‚úÖ Exibindo notifica√ß√£o via API...');
                    showNotification(data.venda_data);
                } else {
                    console.log('‚ÑπÔ∏è Nenhuma venda encontrada na sess√£o via API');
                    // Tentar m√©todo alternativo se a API falhar
                    checkSessionAlternative();
                }
            })
            .catch(error => {
                console.error('‚ùå Erro ao verificar sess√£o via API:', error);
                // Tentar m√©todo alternativo
                checkSessionAlternative();
            });

        // M√©todo alternativo: Verificar se h√° dados passados pelo Django
        function checkSessionAlternative() {
            console.log('üîÑ Tentando m√©todo alternativo...');
            // Se o Django passou os dados diretamente no template
            {% if venda_sucesso %}
                console.log('‚úÖ Dados encontrados diretamente do Django');
                showNotification({
                    cliente: '{{ venda_sucesso.cliente }}',
                    quantidade: '{{ venda_sucesso.quantidade }}',
                    valor: '{{ venda_sucesso.valor }}',
                    data_venda: '{{ venda_sucesso.data_venda }}'
                });
            {% else %}
                console.log('‚ÑπÔ∏è Nenhum dado encontrado no template');
            {% endif %}
        }

        // Evento de submit ao pressionar Enter na busca
        const searchInput = document.querySelector('input[name="busca"]');
        if (searchInput) {
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.form.submit();
                }
            });
        }

        // Submiss√£o autom√°tica ao alterar a ordena√ß√£o
        const orderBySelect = document.getElementById('ordenar_por');
        if (orderBySelect) {
            orderBySelect.addEventListener('change', function () {
                this.form.submit();
            });
        }

        // Submiss√£o autom√°tica ao alterar o status
        const statusSelect = document.getElementById('status');
        if (statusSelect) {
            statusSelect.addEventListener('change', function () {
                this.form.submit();
            });
        }

        // Fechar notifica√ß√£o ao clicar no X
        const closeBtn = document.querySelector('.notification-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', hideNotification);
        }

        // Tamb√©m fechar notifica√ß√£o ao clicar na barra de progresso
        const progressBar = document.querySelector('.notification-progress');
        if (progressBar) {
            progressBar.addEventListener('click', hideNotification);
        }

        // Bot√£o para expandir/contrair lista de vendas
        const toggleListBtn = document.getElementById('toggleListBtn');
        const vendasContainer = document.getElementById('vendasContainer');
        
        if (toggleListBtn && vendasContainer) {
            toggleListBtn.addEventListener('click', function() {
                const isExpanded = vendasContainer.style.maxHeight === 'none';
                
                if (isExpanded) {
                    // Contrair
                    vendasContainer.style.maxHeight = '400px';
                    vendasContainer.style.overflow = 'hidden';
                    toggleListBtn.innerHTML = '<i class="bi bi-chevron-down"></i> Exibir todos os clientes';
                } else {
                    // Expandir
                    vendasContainer.style.maxHeight = 'none';
                    vendasContainer.style.overflow = 'visible';
                    toggleListBtn.innerHTML = '<i class="bi bi-chevron-up"></i> Ocultar lista';
                }
            });
            
            // Inicializar com altura limitada
            vendasContainer.style.maxHeight = '400px';
            vendasContainer.style.overflow = 'hidden';
        }
    });

    console.log('‚úÖ JavaScript incorporado carregado com sucesso');
    </script>

</body>

</html>